name: R analysis (render & figures) 

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  run-r-analysis:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: "4.3"

      - name: Install system libraries (optional)
        run: |
          sudo apt-get update
          sudo apt-get install -y libcairo2-dev libxml2-dev libssl-dev libfontconfig1-dev

      - name: Install R packages and run driver
        run: |
          Rscript -e "options(repos='https://cloud.r-project.org'); source('scripts/install_packages_from_rmd.R'); source('scripts/run_all.R')"

      - name: Upload figures
        uses: actions/upload-artifact@v4
        with:
          name: figures
          path: results/figures
